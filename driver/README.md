# Сервер-движок для игры soa-mafia

В данном репозитории находится реализация движка для игры soa-maria, которая включает в себя:
- [protobuf-схему](https://github.com/fdr896/soa-mafia/blob/main/driver/server/proto/mafia.proto) взаимодействия сервера и клиента
- grpc-сервер, реализующий один rpc-метод `DoAction`, который получает на вход поток действий от клиентов, и в ответ отдаёт им также поток ответов
- grpc-клиент, также реализующий метод `DoAction`. Клиент может работать как в ручном режиме (команды нужно вводить самостоятельно), так и в автоматическом (на каждой этапе случайным образом выбирается, за кого голосовать)

### Установка
Скачать репозиторий и перейти в папку `driver`:
```bash
$ git clone git@github.com:fdr896/soa-mafia.git
$ cd soa-mafia/driver
```

### Запуск игры с ботами
Чтобы запустить сервер и трёх клиентов-ботов, необходимо из директории `driver` выполнить
```bash
$ docker compose up
```
Для запуска клиента нужно в отдельном терминале запустить
```bash
$ CLIENT_MODE=manual SERVER_PORT=9000 USERNAME=best_user go run client/cmd/main.go
```
Далее необходимо проследовать инструкции, которая будет выведена в терминале

После окончания игры, нужно перезапустить `docker compose`

N.B.: Чтобы прервать игру у себя и всех ботов, достаточно ввести команду `exit`
N.B.: Чтобы было удобно перезапускать ботов, можно запустить в одном терминале
```bash
$ docker compose up server
```
А в другом (так, после окончания игры можно перезапускать только ботов)
```bash
$ docker compose up bot1 bot2 bot3
```

### Запуск игры без ботов
Чтобы запустить сервер, необходимо из директории `driver` выполнить
```bash
$ sudo docker compose up
```
Будет автоматически создан сервер, которые ожидает 4-ёх игроков на одну сессию

Далее необходимо запустить 4 клиента с разными `USERNAME`

#### Запуск игры с произвольным числом игроков
Чтобы запустить сервер, который ожидает конкретного числа игроков, необходимо выполнить
```bash
$ sudo docker compose run -e SESSION_PLAYERS=7 -p 9000:9000/tcp server
```

### Обновление докер образов сервера и клиента
Из папки `driver` нужно запустить
```bash
$ chmod +x build.sh
$ ./build.sh
```

