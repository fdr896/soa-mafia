# soa-mafia

### Установка
Скачать репозиторий и перейти в него:
```bash
$ git clone git@github.com:fdr896/soa-mafia.git
$ cd soa-mafia/
```

### Требования к программному обеспечению
Для комфортной работе на хосте должны быть установлены `docker` и `go` версии не меньше `1.19` (всё тестирование проводилось с версией `1.19`)

### Ручная сборка докер образов сервера и клиента
Не потребуется при работе через `docker compose`

Для сборки докер-образов написан специальный скрипт, которые собирает образы и выкладывает их на docker-hub. Для его запуска необходимо выполнить:
```bash
$ chmod +x build.sh
$ ./build.sh
```

## Домашнее задание 2
Реализация и описание интерфейса располагается в [soa-mafia/driver](https://github.com/fdr896/soa-mafia/tree/main/driver)

Взаимодействие с клиентом происходит через чат-интерфейс в командной строке.

Правила использования показываются при запуске:
```
Voting:
    - 'vote' (enter voting mode to vote for mafia)
Chat:
    - 'read' (start reading current day chat)
    - 'read_all' (read all chat history)
    - 'read_last_n' (read last 'n' messages)
    - 'write' (write to game session chat)
Game Information:
    - 'role' (your role)
    - 'state' (game state)
    - 'nicks' (alive players' nicknames)
Interfaction With The Interface:
    - 'exit' (interrupt the game)
    - 'rules' (rules again)
```
В данном домашнем задании раздел `Chat` не используется

При успешном запуске клиента в консоли должно появится сообщение следующего вида:
```
connecting to grpc server by endpoint [localhost:9000]...
connected to grpc server on endpoint [localhost:9000]
2023/06/07 22:08:27 Writing logs to file: /home/fdr400/soa/soa-mafia/.logs/fdr400.log

Hello, fdr400!
Your are connected to the grpc-mafia server! Here you can play mafia!!!
- Type 'start' to connect to random game session
- Type 'exit' to end the game
```
Нужно ввести `start`, и после ожидания всех игроков, клиент подключится к одной из игровых сессий

После начала игры в консоли нужно вводить команды из списка выше. По ходу игры должно быть понятно, что происходит на данный момент

По завершению игры клиент отключается и завершает процесс. Для подключения к новой игре нужно запустить клиента заново

### Запуск игры с ботами
Чтобы запустить сервер и трёх клиентов-ботов, необходимо выполнить
```bash
$ docker compose up
```
Для запуска клиента нужно в отдельном терминале запустить
```bash
$ CLIENT_MODE=manual SERVER_PORT=9000 USERNAME=best_user go run driver/client/cmd/main.go
```
После чего начнётся игра на 4-ёх игроков, один из которых будет мафией, а один комиссаром.

Далее необходимо проследовать инструкции, которая будет выведена в терминале

После окончания игры, процесс клиента завершится, но процессы ботов перезапустятся.
Таким образом, для начала новой игры с ботами можно просто заново запустить клиент

### Запуск игры без ботов
Чтобы запустить сервер, необходимо выполнить (брокер нужен для обратной совместимости со следующими домашники заданиями)
```bash
$ docker compose up rabbitmq server
```
Будет автоматически создан сервер, которые ожидает 4-ёх игроков на одну сессию

Далее необходимо запустить 4 клиента с разными `USERNAME`.

Пример:
![](images/example1.png)

### Запуск игры с заданным числом игроков и мафий
Чтобы запустить сервер, который ожидает заданного числа игроков и мафий, необходимо выполнить
```bash
$ docker compose up rabbitmq -d
$ docker compose run -e SESSION_PLAYERS=6 -e MAFIAS=2 -e PORT=9000 -p 9000:9000/tcp server
```

Мафий должно быть меньше, чем половина всех игроков (иначе мафия победит в первый же день)

Далее нужно запустить указанное число клиентов, каждый из которых может быть как ботом, так и настоящим клиентом.

Пример запуска с 3-мя ботами и 3-мя обычными клиентами:
![](images/example2.png)

### Запуск нескольких сессий игры
Клиенты автоматически подключаются к первой неполной сессии игры, которые сервис создаёт при наполнении предыдущих сессий

## Домашние задание 3
Реализация и описание интерфейса располагается в [soa-mafia/chat](https://github.com/fdr896/soa-mafia/tree/main/chat). Использование интерфейса чата реализовано в [soa-mafia/driver](https://github.com/fdr896/soa-mafia/tree/main/driver)

В клиент добавляется раздел команд для взаимодействия с дневным чатом чатом:
```bash
Chat:
    - 'read' (start reading current day chat)
    - 'read_all' (read all chat history)
    - 'read_last_n' (read last 'n' messages)
    - 'write' (write to game session chat)
```
- `read`: клиент начинает слушать сообщения от всех игроков в его сессии за данный день игры. При запуске этой команды каждый раз выводятся все сообщения за день. Пример: ![](images/example3.png)
- 'read_all': вывод всех сообщений за все дни в рамках игровой сессии
- 'read_last_n': вывод последних `n` сообщений за всю историю игрового чата в рамках данной сессии. Пример: ![](images/example4.png)
- 'write': написать одно сообщение в чат, которое получат все участники игры (кроме духов). Пример: ![](images/example5.png)

### Запуск
Запуск полностью аналогичен запуску сервиса в предыдущем домашнем задании
